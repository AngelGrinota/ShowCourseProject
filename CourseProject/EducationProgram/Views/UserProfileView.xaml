<UserControl x:Class="EducationProgram.Views.UserProfileView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:local="clr-namespace:EducationProgram.Views"
             xmlns:viewmodels="clr-namespace:EducationProgram.ViewModels"
             xmlns:models="clr-namespace:EducationProgram.Models"
             xmlns:converters="clr-namespace:EducationProgram.Converters"
             d:DataContext="{d:DesignInstance viewmodels:UserProfileViewModel}"
             mc:Ignorable="d"
             x:Name="RootControl"
             d:DesignHeight="600" d:DesignWidth="1000" Cursor="">

    <UserControl.Resources>
        <converters:LeaderboardColorConverter x:Key="LeaderboardColorConverter"/>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:ZeroToVisibilityConverter x:Key="ZeroToVisibilityConverter"/>
        <converters:NotZeroToVisibilityConverter x:Key="NotZeroToVisibilityConverter"/>
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        <converters:IntToSortArrowConverter x:Key="IntToSortArrowConverter"/>
        <converters:BoolToArrowConverter x:Key="BoolToArrowConverter"/>
        <converters:GradeColorConverter x:Key="GradeColorConverter"/>
        <converters:ZebraStripeConverter x:Key="ZebraStripeConverter"/>
        <converters:NullToBooleanConverter x:Key="NullToBooleanConverter"/>
        <converters:InverseBooleanToVisibilityConverter x:Key="InverseBooleanConverter"/>
        <converters:NullableIntConverter x:Key="NullableIntConverter"/>
    </UserControl.Resources>

    <DockPanel Background="{StaticResource BackgroundBrush}">

        <Border Background="{StaticResource PrimaryBrush}" Height="60" DockPanel.Dock="Top">
            <DockPanel LastChildFill="True">
                <Image Source="pack://application:,,,/Resources/images/back.png" Width="25" Height="25" Margin="10,0,0,0" Cursor="Hand" ToolTip="Вернуться назад" HorizontalAlignment="Left">
                    <Image.InputBindings>
                        <MouseBinding MouseAction="LeftClick" Command="{Binding NavigateBackCommand}" />
                    </Image.InputBindings>
                    <Image.Style>
                        <Style TargetType="Image">
                            <Setter Property="Opacity" Value="0.5"/>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Opacity" Value="1.0"/>
                                    <Trigger.EnterActions>
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <DoubleAnimation Storyboard.TargetProperty="Opacity" To="1.0" Duration="0:0:0.2"/>
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </Trigger.EnterActions>
                                    <Trigger.ExitActions>
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <DoubleAnimation Storyboard.TargetProperty="Opacity" To="0.5" Duration="0:0:0.2"/>
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </Trigger.ExitActions>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Image.Style>
                </Image>
            </DockPanel>
        </Border>

        <Border Width="370" DockPanel.Dock="Left" Background="{StaticResource WhiteForegroundBrush}" 
        BorderBrush="{StaticResource PrimaryBrush}" BorderThickness="0,0,1,0">
            <StackPanel Margin="10,20,10,10" Cursor="">

                <Border Background="#F9F9FE" CornerRadius="10" Padding="15" Margin="0,0,0,20"
                    BorderBrush="#D6D6F0" BorderThickness="1">
                    <StackPanel>
                        <TextBlock FontSize="18" FontWeight="Bold" Foreground="{StaticResource PurpleBrush}" TextWrapping="Wrap">
                            <TextBlock.Text>
                                <MultiBinding StringFormat="{}{0} {1} {2}">
                                    <Binding Path="CurrentUser.Surname"/>
                                    <Binding Path="CurrentUser.Name"/>
                                    <Binding Path="CurrentUser.Patronymic"/>
                                </MultiBinding>
                            </TextBlock.Text>
                        </TextBlock>


                        <TextBlock Text="{Binding CurrentUser.Login, StringFormat='Логин: {0}'}"
                                   FontSize="14" Foreground="#555" Margin="0,4,0,0"/>

                        <TextBlock Text="{Binding CurrentUser.Group.GroupName, StringFormat='Группа: {0}'}"
                                   FontSize="14" Foreground="#555" Margin="0,2,0,0"
                                   Visibility="{Binding CurrentUser.Group, Converter={StaticResource NullToVisibilityConverter}}"/>
                    </StackPanel>
                </Border>

                <Button Content="Таблица лидеров"
                        Command="{Binding SelectProfileSectionCommand}"
                        CommandParameter="Топ участников"
                        Style="{StaticResource SecondaryButtonStyle}"
                        Height="44"
                        FontSize="16"
                        Margin="0 0 0 10" Cursor="Hand"/>
                
                <Button Content="Пройденные тесты"
                        Command="{Binding SelectProfileSectionCommand}"
                        CommandParameter="Пройденные тесты"
                        Visibility="{Binding IsStudent, Converter={StaticResource BooleanToVisibilityConverter}}"
                        Style="{StaticResource SecondaryButtonStyle}"
                        Height="44"
                        FontSize="16"
                        Margin="0 0 0 10"/>
                
                <Button Content="Успеваемость студентов"
                        Command="{Binding SelectProfileSectionCommand}"
                        CommandParameter="Успеваемость"
                        Visibility="{Binding IsStudent, Converter={StaticResource InverseBooleanConverter}}"
                        Style="{StaticResource SecondaryButtonStyle}"
                        Height="44"
                        FontSize="16"
                        Margin="0 0 0 10"/>

                <Button Content="Список пользователей"
                     Command="{Binding SelectProfileSectionCommand}"
                     CommandParameter="Пользователи"
                     Visibility="{Binding IsAdmin, Converter={StaticResource BooleanToVisibilityConverter}}"
                     Style="{StaticResource SecondaryButtonStyle}"
                     Height="44"
                     FontSize="16"
                     Margin="0 0 0 10"/>

                <Button Content="Список материалов"
                     Command="{Binding SelectProfileSectionCommand}"
                     CommandParameter="Материалы"
                     Visibility="{Binding IsAdmin, Converter={StaticResource BooleanToVisibilityConverter}}"
                     Style="{StaticResource SecondaryButtonStyle}"
                     Cursor="Hand"
                     Height="44"
                     FontSize="16"
                     Margin="0 0 0 10"/>
            </StackPanel>
        </Border>

        <Grid Margin="20">
            <Border Background="{StaticResource WhiteForegroundBrush}" CornerRadius="12" Padding="20">
                <ContentControl Content="{Binding}">
                    <ContentControl.Style>
                        <Style TargetType="ContentControl">
                            <Style.Triggers>

                                <DataTrigger Binding="{Binding SelectedSection}" Value="Пройденные тесты">
                                    <Setter Property="ContentTemplate">
                                        <Setter.Value>
                                            <DataTemplate>
                                                <Grid>
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="*"/>
                                                        <RowDefinition Height="Auto"/>
                                                    </Grid.RowDefinitions>

                                                    <!-- Заголовок -->
                                                    <TextBlock Text="Ваши пройденные тесты"
                                                               FontSize="26" FontWeight="Bold"
                                                               Foreground="{StaticResource PrimaryBrush}"
                                                               Margin="0,0,0,15"/>

                                                    <!-- Шапка таблицы -->
                                                    <Grid Grid.Row="1" Margin="5,0,5,10">
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="2*"/>
                                                            <ColumnDefinition Width="100"/>
                                                            <ColumnDefinition Width="80"/>
                                                            <ColumnDefinition Width="100"/>
                                                            <ColumnDefinition Width="160"/>
                                                        </Grid.ColumnDefinitions>

                                                        <TextBlock Grid.Column="0" Text="Название теста"
                                   FontSize="15" FontWeight="SemiBold" Foreground="#666"/>
                                                        <TextBlock Grid.Column="1" Text="Попытка"
                                   FontSize="15" FontWeight="SemiBold" Foreground="#666"
                                   HorizontalAlignment="Center"/>
                                                        <TextBlock Grid.Column="2" Text="Процент"
                                   FontSize="15" FontWeight="SemiBold" Foreground="#666"
                                   HorizontalAlignment="Center"/>
                                                        <TextBlock Grid.Column="3" Text="Оценка"
                                   FontSize="15" FontWeight="SemiBold" Foreground="#666"
                                   HorizontalAlignment="Center"/>
                                                        <TextBlock Grid.Column="4" Text="Дата прохождения"
                                   FontSize="15" FontWeight="SemiBold" Foreground="#666"
                                   HorizontalAlignment="Center"/>
                                                    </Grid>

                                                    <!-- Основной блок -->
                                                    <Grid Grid.Row="2">

                                                        <!-- Нет данных -->
                                                        <TextBlock Text="Вы ещё не прошли ни один тест."
                                                                   FontSize="18" Foreground="#666"
                                                                   HorizontalAlignment="Center"
                                                                   VerticalAlignment="Center"
                                                                   Visibility="{Binding TestPaging.Items.Count,
                                                                                Converter={StaticResource ZeroToVisibilityConverter}}"/>

                                                        <!-- Есть данные -->
                                                        <ScrollViewer VerticalScrollBarVisibility="Auto"
                                      Visibility="{Binding TestPaging.Items.Count,
                                                   Converter={StaticResource NotZeroToVisibilityConverter}}">
                                                            <ItemsControl ItemsSource="{Binding TestPaging.Items}">
                                                                <ItemsControl.ItemTemplate>
                                                                    <DataTemplate DataType="{x:Type models:TestResultDisplay}">
                                                                        <Border Style="{StaticResource GradeRowStyle}">
                                                                            <Grid>
                                                                                <!-- Общий стиль текста, как в "Успеваемости" -->
                                                                                <Grid.Resources>
                                                                                    <Style TargetType="TextBlock">
                                                                                        <Setter Property="FontSize" Value="15"/>
                                                                                    </Style>
                                                                                </Grid.Resources>

                                                                                <Grid.ColumnDefinitions>
                                                                                    <ColumnDefinition Width="2*"/>
                                                                                    <ColumnDefinition Width="100"/>
                                                                                    <ColumnDefinition Width="80"/>
                                                                                    <ColumnDefinition Width="100"/>
                                                                                    <ColumnDefinition Width="160"/>
                                                                                </Grid.ColumnDefinitions>

                                                                                <TextBlock Grid.Column="0"
                                                           Text="{Binding TestName}"
                                                           TextTrimming="CharacterEllipsis"
                                                           VerticalAlignment="Center"/>

                                                                                <TextBlock Grid.Column="1"
                                                           Text="{Binding AttemptNumber}"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center"/>

                                                                                <TextBlock Grid.Column="2"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center">
                                                    <Run Text="{Binding Percent, StringFormat={}{0:N0}}"/>
                                                    <Run Text="%"/>
                                                                                </TextBlock>

                                                                                <Border Grid.Column="3"
                                                        CornerRadius="4"
                                                        Width="28" Height="30"
                                                        HorizontalAlignment="Center"
                                                        Background="{Binding Grade,
                                                            Converter={StaticResource GradeColorConverter},
                                                            ConverterParameter=Background}">
                                                                                    <TextBlock Text="{Binding Grade}"
                                                               HorizontalAlignment="Center"
                                                               VerticalAlignment="Center"
                                                               FontWeight="ExtraBold"
                                                               Foreground="{Binding Grade,
                                                                   Converter={StaticResource GradeColorConverter}}"/>
                                                                                </Border>

                                                                                <TextBlock Grid.Column="4"
                                                           Text="{Binding PassedAt, StringFormat='dd.MM.yyyy HH:mm'}"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center"/>
                                                                            </Grid>
                                                                        </Border>
                                                                    </DataTemplate>
                                                                </ItemsControl.ItemTemplate>
                                                            </ItemsControl>
                                                        </ScrollViewer>

                                                    </Grid>

                                                    <!-- Пагинация -->
                                                    <StackPanel Grid.Row="3" Orientation="Horizontal"
                                HorizontalAlignment="Center" Margin="0,10,0,0">

                                                        <Button Content="◀ Назад"
                                Command="{Binding PrevPageCommand}"
                                IsEnabled="{Binding TestPaging.CanGoPrev}"
                                Margin="5"
                                Style="{StaticResource SecondaryButtonStyle}"
                                Width="80" Height="50"/>

                                                        <TextBlock Text="{Binding TestPaging.CurrentPage}"
                                   VerticalAlignment="Center" Margin="5" FontSize="15"/>

                                                        <TextBlock Text="/" VerticalAlignment="Center" FontSize="15"/>

                                                        <TextBlock Text="{Binding TestPaging.TotalPages}"
                                   VerticalAlignment="Center" Margin="5" FontSize="15"/>

                                                        <Button Content="Вперед ▶"
                                Command="{Binding NextPageCommand}"
                                IsEnabled="{Binding TestPaging.CanGoNext}"
                                Margin="5"
                                Style="{StaticResource SecondaryButtonStyle}"
                                Width="80" Height="50"/>
                                                    </StackPanel>

                                                </Grid>
                                            </DataTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </DataTrigger>


                                <DataTrigger Binding="{Binding SelectedSection}" Value="Топ участников">
                                    <Setter Property="ContentTemplate">
                                        <Setter.Value>
                                            <DataTemplate>
                                                <Grid>
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="*"/>
                                                        <RowDefinition Height="Auto"/>
                                                    </Grid.RowDefinitions>

                                                    <!-- Заголовок -->
                                                    <TextBlock Text="Таблица лидеров"
                                                               FontSize="28"
                                                               FontWeight="Bold"
                                                               Foreground="{StaticResource PrimaryBrush}"
                                                               Margin="0,0,0,15"/>

                                                    <!-- Таблица -->
                                                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                                                        <ItemsControl ItemsSource="{Binding LeaderboardPaging.Items}">

                                                            <!-- ПАНЕЛЬ -->
                                                            <ItemsControl.ItemsPanel>
                                                                <ItemsPanelTemplate>
                                                                    <StackPanel IsItemsHost="True"/>
                                                                </ItemsPanelTemplate>
                                                            </ItemsControl.ItemsPanel>

                                                            <!-- ШАБЛОН СТРОКИ -->
                                                            <ItemsControl.ItemTemplate>
                                                                <DataTemplate DataType="{x:Type models:Leaderboard}">

                                                                    <!-- Строка с наведением -->
                                                                    <Border Margin="0,2"
                                                                            Padding="10"
                                                                            CornerRadius="6"
                                                                            Background="White"
                                                                            BorderBrush="#E3E7F5"
                                                                            BorderThickness="1">

                                                                        <Border.Style>
                                                                            <Style TargetType="Border">
                                                                                <Setter Property="Opacity" Value="1"/>
                                                                                <Style.Triggers>
                                                                                    <Trigger Property="IsMouseOver" Value="True">
                                                                                        <Setter Property="Background" Value="#F2F6FF"/>
                                                                                        <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrush}"/>
                                                                                    </Trigger>
                                                                                </Style.Triggers>
                                                                            </Style>
                                                                        </Border.Style>

                                                                        <Grid>
                                                                            <Grid.ColumnDefinitions>
                                                                                <ColumnDefinition Width="70"/>
                                                                                <ColumnDefinition Width="2.5*"/>
                                                                                <ColumnDefinition Width="1.3*"/>
                                                                                <ColumnDefinition Width="130"/>
                                                                            </Grid.ColumnDefinitions>

                                                                            <!-- РАНГ / МЕСТО -->
                                                                            <Border Grid.Column="0"
                                                                                    Width="40" Height="40"
                                                                                    HorizontalAlignment="Center"
                                                                                    VerticalAlignment="Center"
                                                                                    CornerRadius="6"
                                                                                    Background="{Binding Rank, Converter={StaticResource LeaderboardColorConverter}, ConverterParameter=Background}">

                                                                                <TextBlock Text="{Binding Rank}"
                                                                                           HorizontalAlignment="Center"
                                                                                           VerticalAlignment="Center"
                                                                                           FontSize="18"
                                                                                           FontWeight="ExtraBold"
                                                                                           Foreground="{Binding Rank, Converter={StaticResource LeaderboardColorConverter}}"/>
                                                                            </Border>

                                                                            <!-- ФИО -->
                                                                            <TextBlock Grid.Column="1"
                                                                                       Margin="10,0"
                                                                                       FontSize="16"
                                                                                       VerticalAlignment="Center"
                                                                                       TextTrimming="CharacterEllipsis">
                                                                                <TextBlock.Text>
                                                                                    <MultiBinding StringFormat="{}{0} {1} {2}">
                                                                                        <Binding Path="Surname"/>
                                                                                        <Binding Path="Name"/>
                                                                                        <Binding Path="Patronymic"/>
                                                                                    </MultiBinding>
                                                                                </TextBlock.Text>
                                                                            </TextBlock>

                                                                            <!-- ГРУППА -->
                                                                            <TextBlock Grid.Column="2"
                                                                                       Text="{Binding GroupName}"
                                                                                       FontSize="15"
                                                                                       Foreground="#555"
                                                                                       HorizontalAlignment="Center"
                                                                                       VerticalAlignment="Center"/>

                                                                            <!-- БАЛЛЫ -->
                                                                            <TextBlock Grid.Column="3"
                                                                                        Text="{Binding TotalScore, StringFormat='{}{0} баллов'}"
                                                                                        FontSize="17"
                                                                                        FontWeight="SemiBold"
                                                                                        Foreground="{StaticResource PrimaryBrush}"
                                                                                        HorizontalAlignment="Center"
                                                                                        VerticalAlignment="Center"/>
                                                                        </Grid>
                                                                    </Border>

                                                                </DataTemplate>
                                                            </ItemsControl.ItemTemplate>

                                                        </ItemsControl>
                                                    </ScrollViewer>

                                                    <!-- Пагинация -->
                                                    <StackPanel Grid.Row="2"
                                Orientation="Horizontal"
                                HorizontalAlignment="Center"
                                Margin="0,15,0,0">

                                                        <Button Content="◀ Назад"
                                Command="{Binding PrevPageCommand}"
                                IsEnabled="{Binding LeaderboardPaging.CanGoPrev}"
                                Margin="5"
                                Style="{StaticResource SecondaryButtonStyle}"
                                Width="90" Height="45"/>

                                                        <TextBlock Text="{Binding LeaderboardPaging.CurrentPage}"
                                   FontSize="16"
                                   VerticalAlignment="Center" Margin="5"/>

                                                        <TextBlock Text="/" VerticalAlignment="Center" FontSize="16"/>

                                                        <TextBlock Text="{Binding LeaderboardPaging.TotalPages}"
                                   FontSize="16"
                                   VerticalAlignment="Center" Margin="5"/>

                                                        <Button Content="Вперед ▶"
                                Command="{Binding NextPageCommand}"
                                IsEnabled="{Binding LeaderboardPaging.CanGoNext}"
                                Margin="5"
                                Style="{StaticResource SecondaryButtonStyle}"
                                Width="90" Height="45"/>

                                                    </StackPanel>

                                                </Grid>
                                            </DataTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </DataTrigger>

                                <DataTrigger Binding="{Binding SelectedSection}" Value="Успеваемость">
                                    <Setter Property="ContentTemplate">
                                        <Setter.Value>
                                            <DataTemplate>
                                                <Grid>
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="*"/>
                                                        <RowDefinition Height="Auto"/>
                                                    </Grid.RowDefinitions>

                                                    <TextBlock Text="Успеваемость студентов" FontSize="26" FontWeight="Bold" Foreground="{StaticResource PrimaryBrush}" Margin="0,0,0,15"/>

                                                    <Border Grid.Row="1" Background="#F0F4FF" BorderBrush="{StaticResource AccentBrush}" BorderThickness="1" CornerRadius="8" Padding="10" Margin="0,0,0,15">
                                                        <StackPanel Orientation="Vertical" >
                                                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,0,10">
                                                               <TextBlock Text="Поиск по ФИО:" VerticalAlignment="Center" FontWeight="SemiBold" Foreground="#444" Margin="0,0,10,0"/>
    
                                                                <TextBox Text="{Binding SearchFio, UpdateSourceTrigger=PropertyChanged}" 
                                                                         Width="250" 
                                                                         Height="30" 
                                                                         Padding="5" 
                                                                         MaxLength="100" 
                                                                         Style="{StaticResource PrimaryTextBoxStyle}"/>
                                                                
                                                                <Button Command="{Binding ToggleFioSortCommand}" Margin="10,0,0,0" Height="30" Padding="5,10" 
                                                                        Style="{StaticResource SecondaryButtonStyle}" Width="150">
                                                                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                                        <TextBlock Text="Сортировать по ФИО" VerticalAlignment="Center"/>
                                                                        <TextBlock Text="{Binding IsFioAscending, Converter={StaticResource BoolToArrowConverter}}" FontSize="14" Margin="5,0,0,0" VerticalAlignment="Center"/>
                                                                    </StackPanel>
                                                                </Button>
                                                                <Button Command="{Binding ToggleDateSortCommand}" Margin="10,0,0,0" Height="30" Padding="5,10" Style="{StaticResource SecondaryButtonStyle}" Width="140">
                                                                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                                        <TextBlock Text="Сортировать по дате" VerticalAlignment="Center"/>
                                                                        <TextBlock Text="{Binding DateSortState, Converter={StaticResource IntToSortArrowConverter}}" FontSize="14" Margin="5,0,0,0" VerticalAlignment="Center"/>
                                                                    </StackPanel>
                                                                </Button>
                                                                <Button Content="Сбросить фильтры" Command="{Binding ResetFiltersCommand}" Style="{StaticResource AccentButtonStyle}" Margin="10,0,0,0" Height="30" Width="120"/>
                                                                <Button Content="Экспорт в Excel" 
                                                                        Command="{Binding ExportResultsCommand}" 
                                                                        Style="{StaticResource AccentButtonStyle}" 
                                                                        Margin="10,0,0,0" Height="30" Width="130"/>
                                                            </StackPanel>

                                                            <WrapPanel>
                                                                <StackPanel Margin="0,0,15,0">
                                                                    <TextBlock Text="Группа:" Foreground="#666" Margin="0,0,0,4"/>
                                                                    <ComboBox ItemsSource="{Binding FilterGroups}" SelectedItem="{Binding SelectedGroupFilter}" DisplayMemberPath="GroupName" Width="150" Style="{StaticResource PrimaryComboBoxStyle}" ItemContainerStyle="{StaticResource PrimaryComboBoxItemStyle}"/>
                                                                </StackPanel>
                                                                <StackPanel Margin="0,0,15,0">
                                                                    <TextBlock Text="Тест:" Foreground="#666" Margin="0,0,0,4"/>
                                                                    <ComboBox ItemsSource="{Binding FilterTests}" SelectedItem="{Binding SelectedTestFilter}" Width="400" Style="{StaticResource PrimaryComboBoxStyle}" ItemContainerStyle="{StaticResource PrimaryComboBoxItemStyle}">
                                                                        <ComboBox.ItemTemplate>
                                                                            <DataTemplate>
                                                                                <TextBlock Text="{Binding TestName}" TextTrimming="CharacterEllipsis"/>
                                                                            </DataTemplate>
                                                                        </ComboBox.ItemTemplate>
                                                                    </ComboBox>
                                                                </StackPanel>
                                                                <StackPanel Margin="0,0,15,0">
                                                                    <TextBlock Text="Оценка:" Foreground="#666" Margin="0,0,0,4"/>
                                                                    <ComboBox ItemsSource="{Binding FilterGrades}" SelectedItem="{Binding SelectedGradeFilter}" Width="80" Style="{StaticResource PrimaryComboBoxStyle}" ItemContainerStyle="{StaticResource PrimaryComboBoxItemStyle}"/>
                                                                </StackPanel>
                                                            </WrapPanel>
                                                        </StackPanel>
                                                    </Border>

                                                    <Grid Grid.Row="2" Margin="5,0,5,10">
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="1.2*"/>
                                                            <ColumnDefinition Width="1.8*"/>
                                                            <ColumnDefinition Width="1.4*"/>
                                                            <ColumnDefinition Width="1.4*"/>
                                                            <ColumnDefinition Width="1.2*"/>
                                                            <ColumnDefinition Width="2.5*"/>
                                                            <ColumnDefinition Width="70"/>
                                                            <ColumnDefinition Width="150"/>
                                                        </Grid.ColumnDefinitions>

                                                        <TextBlock Grid.Column="0" Text="Логин" FontWeight="SemiBold" Foreground="#666"/>
                                                        <TextBlock Grid.Column="1" Text="Фамилия" FontWeight="SemiBold" Foreground="#666"/>
                                                        <TextBlock Grid.Column="2" Text="Имя" FontWeight="SemiBold" Foreground="#666"/>
                                                        <TextBlock Grid.Column="3" Text="Отчество" FontWeight="SemiBold" Foreground="#666"/>
                                                        <TextBlock Grid.Column="4" Text="Группа" FontWeight="SemiBold" Foreground="#666"/>
                                                        <TextBlock Grid.Column="5" Text="Тест" FontWeight="SemiBold" Foreground="#666"/>
                                                        <TextBlock Grid.Column="6" Text="Оценка" FontWeight="SemiBold" Foreground="#666" HorizontalAlignment="Center"/>
                                                        <TextBlock Grid.Column="7" Text="Дата" FontWeight="SemiBold" Foreground="#666" HorizontalAlignment="Center"/>
                                                    </Grid>
    

                                                    <ScrollViewer Grid.Row="3" VerticalScrollBarVisibility="Auto">
                                                        <ItemsControl ItemsSource="{Binding StudentPaging.Items}">
                                                            <ItemsControl.ItemTemplate>
                                                                <DataTemplate DataType="{x:Type models:TestResultDisplay}">
                                                                    <Border Style="{StaticResource GradeRowStyle}">
                                                                        <Grid>
                                                                            <Grid.Resources>
                                                                                <Style TargetType="TextBlock">
                                                                                    <Setter Property="FontSize" Value="15"/>
                                                                                </Style>
                                                                            </Grid.Resources>
                                                                            <Grid.ColumnDefinitions>
                                                                                <ColumnDefinition Width="1.2*"/>
                                                                                <ColumnDefinition Width="1.8*"/>
                                                                                <ColumnDefinition Width="1.4*"/>
                                                                                <ColumnDefinition Width="1.4*"/>
                                                                                <ColumnDefinition Width="1.2*"/>
                                                                                <ColumnDefinition Width="2.5*"/>
                                                                                <ColumnDefinition Width="70"/>
                                                                                <ColumnDefinition Width="150"/>
                                                                            </Grid.ColumnDefinitions>

                                                                            <!-- Левые поля — выравнивание left -->
                                                                            <TextBlock Grid.Column="0" Text="{Binding UserLogin}" 
                                                                                        TextTrimming="CharacterEllipsis"
                                                                                        VerticalAlignment="Center"/>

                                                                            <TextBlock Grid.Column="1" Text="{Binding Surname}"
                                                                                       TextTrimming="CharacterEllipsis"
                                                                                       VerticalAlignment="Center"/>

                                                                            <TextBlock Grid.Column="2" Text="{Binding Name}"
                                                                                       TextTrimming="CharacterEllipsis"
                                                                                       VerticalAlignment="Center"/>

                                                                            <TextBlock Grid.Column="3" Text="{Binding Patronymic}"
                                                                                       TextTrimming="CharacterEllipsis"
                                                                                       VerticalAlignment="Center"/>

                                                                            <TextBlock Grid.Column="4" Text="{Binding UserGroup}"
                                                                                        VerticalAlignment="Center"/>

                                                                            <!-- Тест — может быть длинным -->
                                                                            <TextBlock Grid.Column="5" Text="{Binding TestName}"
                                                                                       ToolTip="{Binding TestName}"
                                                                                       TextTrimming="CharacterEllipsis"
                                                                                       VerticalAlignment="Center"/>

                                                                            <!-- Оценка по центру -->
                                                                            <Border Grid.Column="6" CornerRadius="4"
                                                                                    Background="{Binding Grade, Converter={StaticResource GradeColorConverter}, ConverterParameter=Background}"
                                                                                    HorizontalAlignment="Center" Width="28" Height="30">
                                                                                <TextBlock Text="{Binding Grade}" 
                                                                                           HorizontalAlignment="Center" VerticalAlignment="Center"
                                                                                           Foreground="{Binding Grade, Converter={StaticResource GradeColorConverter}}"
                                                                                           FontWeight="ExtraBold"/>
                                                                            </Border>

                                                                            <!-- Дата — по центру -->
                                                                            <TextBlock Grid.Column="7" 
                                                                                       Text="{Binding PassedAt, StringFormat='dd.MM.yyyy HH:mm'}"
                                                                                       HorizontalAlignment="Center"
                                                                                       VerticalAlignment="Center"/>
                                                                        </Grid>
                                                                    </Border>

                                                                </DataTemplate>
                                                            </ItemsControl.ItemTemplate>
                                                        </ItemsControl>
                                                    </ScrollViewer>

                                                    <TextBlock Grid.Row="3" Text="Нет записей, соответствующих фильтрам." FontSize="18" Foreground="#666" HorizontalAlignment="Center" VerticalAlignment="Center" Visibility="{Binding StudentPaging.Items.Count, Converter={StaticResource ZeroToVisibilityConverter}}"/>

                                                    <StackPanel Grid.Row="4" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,10,0,0">
                                                        <Button Content="◀ Назад" Command="{Binding PrevPageCommand}" 
                                                                IsEnabled="{Binding StudentPaging.CanGoPrev}" Margin="5" 
                                                                Style="{StaticResource SecondaryButtonStyle}" Width="80" Height="50"/>
                                                        <TextBlock Text="{Binding StudentPaging.CurrentPage}" VerticalAlignment="Center" Margin="5"/>
                                                        <TextBlock Text="/" VerticalAlignment="Center"/>
                                                        <TextBlock Text="{Binding StudentPaging.TotalPages}" VerticalAlignment="Center" Margin="5"/>
                                                        <Button Content="Вперед ▶" Command="{Binding NextPageCommand}" 
                                                                IsEnabled="{Binding StudentPaging.CanGoNext}" Margin="5" 
                                                                Style="{StaticResource SecondaryButtonStyle}" Width="80" Height="50"/>
                                                    </StackPanel>

                                                </Grid>
                                            </DataTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </DataTrigger>

                                <DataTrigger Binding="{Binding SelectedSection}" Value="Пользователи">
                                    <Setter Property="ContentTemplate">
                                        <Setter.Value>
                                            <DataTemplate>

                                                <Grid>
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="Auto"/>
                                                        <!-- Заголовок -->
                                                        <RowDefinition Height="Auto"/>
                                                        <!-- Поиск -->
                                                        <RowDefinition Height="Auto"/>
                                                        <!-- Шапка -->
                                                        <RowDefinition Height="*"/>
                                                        <!-- Таблица -->
                                                        <RowDefinition Height="Auto"/>
                                                        <!-- Пагинация -->
                                                    </Grid.RowDefinitions>

                                                    <!-- Заголовок -->
                                                    <TextBlock Text="Список пользователей"
                                                               FontSize="28"
                                                               FontWeight="Bold"
                                                               Foreground="{StaticResource PrimaryBrush}"
                                                               Margin="0,0,0,20"/>

                                                    <!-- Панель поиска -->
                                                    <Border Grid.Row="1"
                                                            Background="#F5F7FF"
                                                            BorderBrush="{StaticResource AccentBrush}"
                                                            BorderThickness="1"
                                                            CornerRadius="10"
                                                            Padding="12"
                                                            Margin="0,0,0,20">

                                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="10">

                                                            <Button Content="Создать преподавателя"
                                                                    Command="{Binding DataContext.CreateTeacherCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                                    Style="{StaticResource AccentButtonStyle}"
                                                                    MinWidth="195"
                                                                    Height="42"
                                                                    Margin="0,0,10,0"
                                                                    FontSize="16"/>

                                                            <TextBlock Text="Поиск по ФИО:"
                                                                       VerticalAlignment="Center"
                                                                       FontWeight="SemiBold"
                                                                       Foreground="#555"
                                                                       FontSize="16"
                                                                       Margin="0,0,5,0"/>

                                                            <TextBox Text="{Binding SearchUserFio, UpdateSourceTrigger=PropertyChanged}"
                                                                     Width="470"
                                                                     Height="40"
                                                                     Padding="8"
                                                                     MaxLength="50"
                                                                     FontSize="16"
                                                                     Style="{StaticResource PrimaryTextBoxStyle}"/>
                                                        </StackPanel>

                                                    </Border>

                                                    <!-- Шапка таблицы -->
                                                    <Grid Grid.Row="2" Margin="5,0,5,10">
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="1.3*"/>
                                                            <ColumnDefinition Width="2*"/>
                                                            <ColumnDefinition Width="1.6*"/>
                                                            <ColumnDefinition Width="1.6*"/>
                                                            <ColumnDefinition Width="1.3*"/>
                                                            <ColumnDefinition Width="1.3*"/>
                                                            <ColumnDefinition Width="100"/>
                                                        </Grid.ColumnDefinitions>

                                                        <Grid.Resources>
                                                            <Style TargetType="TextBlock">
                                                                <Setter Property="FontSize" Value="15"/>
                                                                <Setter Property="FontWeight" Value="SemiBold"/>
                                                            </Style>
                                                        </Grid.Resources>

                                                        <TextBlock Grid.Column="0" Text="Логин" Foreground="#666"/>
                                                        <TextBlock Grid.Column="1" Text="Фамилия"  Foreground="#666"/>
                                                        <TextBlock Grid.Column="2" Text="Имя" Foreground="#666"/>
                                                        <TextBlock Grid.Column="3" Text="Отчество" Foreground="#666"/>
                                                        <TextBlock Grid.Column="4" Text="Роль" Foreground="#666"/>
                                                        <TextBlock Grid.Column="5" Text="Группа" Foreground="#666"/>
                                                        <TextBlock Grid.Column="6" Text="Действия" Foreground="#666" HorizontalAlignment="Center"/>
                                                    </Grid>

                                                    <!-- ТАБЛИЦА -->
                                                    <ScrollViewer Grid.Row="3" VerticalScrollBarVisibility="Auto" Margin="0,0,0,15">

                                                        <ItemsControl ItemsSource="{Binding DataContext.UsersPaging.Items, RelativeSource={RelativeSource AncestorType=UserControl}}">

                                                            <ItemsControl.ItemsPanel>
                                                                <ItemsPanelTemplate>
                                                                    <StackPanel IsItemsHost="True"/>
                                                                </ItemsPanelTemplate>
                                                            </ItemsControl.ItemsPanel>

                                                            <ItemsControl.ItemTemplate>
                                                                <DataTemplate>
                                                                    <Border Style="{StaticResource UserRowStyle}">
                                                                        <Grid Cursor="">

                                                                            <Grid.Resources>
                                                                                <Style TargetType="TextBlock">
                                                                                    <Setter Property="FontSize" Value="17"/>
                                                                                </Style>
                                                                            </Grid.Resources>

                                                                            <Grid.ColumnDefinitions>
                                                                                <ColumnDefinition Width="1.3*"/>
                                                                                <ColumnDefinition Width="2*"/>
                                                                                <ColumnDefinition Width="1.6*"/>
                                                                                <ColumnDefinition Width="1.6*"/>
                                                                                <ColumnDefinition Width="1.3*"/>
                                                                                <ColumnDefinition Width="1.3*"/>
                                                                                <ColumnDefinition Width="100"/>
                                                                            </Grid.ColumnDefinitions>

                                                                            <TextBlock Grid.Column="0" Text="{Binding Login}" TextTrimming="CharacterEllipsis"
                                                       VerticalAlignment="Center"/>

                                                                            <TextBlock Grid.Column="1" Text="{Binding Surname}" TextTrimming="CharacterEllipsis"
                                                       VerticalAlignment="Center"/>

                                                                            <TextBlock Grid.Column="2" Text="{Binding Name}" TextTrimming="CharacterEllipsis"
                                                       VerticalAlignment="Center"/>

                                                                            <TextBlock Grid.Column="3" Text="{Binding Patronymic}" TextTrimming="CharacterEllipsis"
                                                       VerticalAlignment="Center"/>

                                                                            <TextBlock Grid.Column="4" Text="{Binding Role.RoleName}" TextTrimming="CharacterEllipsis"
                                                       VerticalAlignment="Center"
                                                       Foreground="{StaticResource PrimaryBrush}" FontWeight="SemiBold"/>

                                                                            <TextBlock Grid.Column="5" Text="{Binding Group.GroupName}" TextTrimming="CharacterEllipsis"
                                                       VerticalAlignment="Center"/>

                                                                            <StackPanel Grid.Column="6" Orientation="Horizontal"
                                                                                        HorizontalAlignment="Center" VerticalAlignment="Center">

                                                                                <!-- Edit Image -->
                                                                                <Image Width="30" Height="30" Margin="0,0,10,0"
                                                                                       Source="pack://application:,,,/Resources/Images/edit.png"
                                                                                       ToolTip="Редактировать"
                                                                                       Cursor="Hand">
                                                                                    <Image.InputBindings>
                                                                                        <MouseBinding MouseAction="LeftClick"
                                                                                                      Command="{Binding DataContext.EditUserCommand, ElementName=RootControl}"
                                                                                                      CommandParameter="{Binding}" />
                                                                                    </Image.InputBindings>
                                                                                </Image>

                                                                                <!-- Delete Image -->
                                                                                <Image Width="30" Height="30"
                                                                                       Source="pack://application:,,,/Resources/Images/delete.png"
                                                                                       ToolTip="Удалить"
                                                                                       Cursor="Hand">
                                                                                    <Image.InputBindings>
                                                                                        <MouseBinding MouseAction="LeftClick"
                                                                                                      Command="{Binding DataContext.DeleteUserCommand, ElementName=RootControl}"
                                                                                                      CommandParameter="{Binding}" />
                                                                                    </Image.InputBindings>
                                                                                </Image>
                                                                            </StackPanel>
                                                                        </Grid>
                                                                    </Border>
                                                                </DataTemplate>
                                                            </ItemsControl.ItemTemplate>
                                                        </ItemsControl>
                                                    </ScrollViewer>

                                                    <!-- Сообщение, если нет пользователей -->
                                                    <TextBlock Grid.Row="3"
                                                               Text="Пользователи не найдены."
                                                               FontSize="20"
                                                               FontWeight="SemiBold"
                                                               Foreground="#999"
                                                               HorizontalAlignment="Center"
                                                               VerticalAlignment="Center"
                                                               Visibility="{Binding DataContext.UsersPaging.Items.Count, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource ZeroToVisibilityConverter}}"/>

                                                    <!-- Пагинация -->
                                                    <StackPanel Grid.Row="4" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,10,0,0">
                                                        <Button Content="◀ Назад"
                                                                Command="{Binding PrevPageCommand}"
                                                                IsEnabled="{Binding UsersPaging.CanGoPrev}"
                                                                Margin="5"
                                                                Style="{StaticResource SecondaryButtonStyle}"
                                                                Width="80" Height="50"/>

                                                        <TextBlock Text="{Binding UsersPaging.CurrentPage}" VerticalAlignment="Center" Margin="5"/>
                                                        <TextBlock Text="/" VerticalAlignment="Center"/>
                                                        <TextBlock Text="{Binding UsersPaging.TotalPages}" VerticalAlignment="Center" Margin="5"/>

                                                        <Button Content="Вперед ▶"
                                                                Command="{Binding NextPageCommand}"
                                                                IsEnabled="{Binding UsersPaging.CanGoNext}"
                                                                Margin="5"
                                                                Style="{StaticResource SecondaryButtonStyle}"
                                                                Width="80" Height="50"/>
                                                    </StackPanel>
                                                </Grid>
                                            </DataTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </DataTrigger>

                                <DataTrigger Binding="{Binding SelectedSection}" Value="Материалы">
                                    <Setter Property="ContentTemplate">
                                        <Setter.Value>
                                            <DataTemplate>
                                                <Grid>

                                                    <ContentControl Visibility="{Binding IsShowingMaterialList, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                        <Grid>
                                                            <Grid.RowDefinitions>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="*"/>
                                                            </Grid.RowDefinitions>

                                                            <Grid Grid.Row="0" Margin="0,0,0,15">
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="Auto"/>
                                                                    <!-- Заголовок -->
                                                                    <ColumnDefinition Width="20"/>
                                                                    <!-- Отступ -->
                                                                    <ColumnDefinition Width="150"/>
                                                                    <!-- ComboBox -->
                                                                    <ColumnDefinition Width="*"/>
                                                                    <!-- Кнопка растягивается -->
                                                                </Grid.ColumnDefinitions>

                                                                <!-- ЗАГОЛОВОК -->
                                                                <TextBlock Grid.Column="0"
                                                                           Text="Список материалов"
                                                                           FontSize="26"
                                                                           FontWeight="Bold"
                                                                           Foreground="{StaticResource PrimaryBrush}"
                                                                           VerticalAlignment="Center"/>

                                                                <!-- COMBOBOX -->
                                                                <ComboBox Grid.Column="2"
                                                                          Width="150"
                                                                          Height="35"
                                                                          FontSize="16"
                                                                          VerticalContentAlignment="Center"
                                                                          SelectedValuePath="Content"
                                                                          Style="{StaticResource PrimaryComboBoxStyle}"
                                                                          ItemContainerStyle="{StaticResource PrimaryComboBoxItemStyle}"
                                                                          SelectedValue="{Binding SelectedMaterialType}">
                                                                    <ComboBoxItem Content="Тесты"/>
                                                                    <ComboBoxItem Content="Параграфы"/>
                                                                </ComboBox>

                                                                <Button Grid.Column="3"
                                                                        Content="Создать новый тест"
                                                                        Command="{Binding OpenTestCreationViewCommand}"
                                                                        Style="{StaticResource AccentButtonStyle}"
                                                                        Height="40"
                                                                        FontSize="16"
                                                                        HorizontalAlignment="Stretch"
                                                                        Margin="20,0,0,0"/>
                                                            </Grid>

                                                            <Grid Grid.Row="1">
                                                                <Grid.RowDefinitions>
                                                                    <RowDefinition Height="*"/>
                                                                    <RowDefinition Height="Auto"/>
                                                                </Grid.RowDefinitions>

                                                                <ContentControl Grid.Row="0">
                                                                    <ContentControl.Style>
                                                                        <Style TargetType="ContentControl">
                                                                            <Setter Property="ContentTemplate">
                                                                                <Setter.Value>
                                                                                    <DataTemplate>
                                                                                        <Grid>
                                                                                            <Grid.RowDefinitions>
                                                                                                <RowDefinition Height="Auto"/>
                                                                                                <RowDefinition Height="*"/>
                                                                                            </Grid.RowDefinitions>

                                                                                            <Grid Grid.Row="0" Margin="5,0,5,5">
                                                                                                <Grid.ColumnDefinitions>
                                                                                                    <ColumnDefinition Width="2*"/>
                                                                                                    <ColumnDefinition Width="3*"/>
                                                                                                    <ColumnDefinition Width="1.5*"/>
                                                                                                    <ColumnDefinition Width="1*"/>
                                                                                                </Grid.ColumnDefinitions>
                                                                                                <TextBlock Grid.Column="0" Text="Тема" FontSize="14" FontWeight="SemiBold" Foreground="#888"/>
                                                                                                <TextBlock Grid.Column="1" Text="Название теста" FontSize="14" FontWeight="SemiBold" Foreground="#888"/>
                                                                                                <TextBlock Grid.Column="2" Text="Количество попыток" FontSize="14" FontWeight="SemiBold" Foreground="#888" HorizontalAlignment="Center"/>
                                                                                                <TextBlock Grid.Column="3" Text="Действия" FontSize="14" FontWeight="SemiBold" Foreground="#888" HorizontalAlignment="Center"/>
                                                                                            </Grid>

                                                                                            <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                                                                                                <Grid>
                                                                                                    <TextBlock Text="Тестов пока нет."
                                                                                                               FontSize="18" Foreground="#666" HorizontalAlignment="Center" VerticalAlignment="Center"
                                                                                                               Visibility="{Binding DataContext.TestsPaging.Items.Count,
                                                                                                                                     RelativeSource={RelativeSource AncestorType=UserControl},
                                                                                                                                     Converter={StaticResource ZeroToVisibilityConverter}}"/>
                                                                                                    <ItemsControl ItemsSource="{Binding DataContext.TestsPaging.Items,
                                                                                                                    RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                                                                                 Visibility="{Binding DataContext.TestsPaging.Items.Count,
                                                                                                                 RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource NotZeroToVisibilityConverter}}">
                                                                                                        <ItemsControl.ItemTemplate>
                                                                                                            <DataTemplate DataType="{x:Type models:Test}">
                                                                                                                <Border BorderBrush="{StaticResource AccentBrush}" BorderThickness="0,0,0,1" Padding="5">
                                                                                                                    <Grid>
                                                                                                                        <Grid.ColumnDefinitions>
                                                                                                                            <ColumnDefinition Width="2*"/>
                                                                                                                            <ColumnDefinition Width="3*"/>
                                                                                                                            <ColumnDefinition Width="1.5*"/>
                                                                                                                            <ColumnDefinition Width="1*"/>
                                                                                                                        </Grid.ColumnDefinitions>
                                                                                                                        <TextBlock Grid.Column="0" Text="{Binding Theme.ThemeTitle}" Foreground="{StaticResource PrimaryBrush}" TextTrimming="CharacterEllipsis" Style="{StaticResource TableTextStyle}"/>
                                                                                                                        <TextBlock Grid.Column="1" Text="{Binding TestName}" TextTrimming="CharacterEllipsis" Style="{StaticResource TableTextStyle}"/>
                                                                                                                        <TextBlock Grid.Column="2" Text="{Binding MaxAttempts}" HorizontalAlignment="Center" Style="{StaticResource TableTextStyle}"/>
                                                                                                                        <StackPanel Grid.Column="3" Orientation="Horizontal" HorizontalAlignment="Center">
                                                                                                                            <Image  Width="30" Height="30"
                                                                                                                                    Source="pack://application:,,,/Resources/Images/delete.png"
                                                                                                                                    ToolTip="Удалить тест"
                                                                                                                                    Cursor="Hand">
                                                                                                                                <Image.InputBindings>
                                                                                                                                    <MouseBinding MouseAction="LeftClick"
                                                                                                                                                  Command="{Binding DataContext.DeleteTestCommand, ElementName=RootControl}"
                                                                                                                                                  CommandParameter="{Binding}" />
                                                                                                                                </Image.InputBindings>
                                                                                                                            </Image>
                                                                                                                        </StackPanel>
                                                                                                                    </Grid>
                                                                                                                </Border>
                                                                                                            </DataTemplate>
                                                                                                        </ItemsControl.ItemTemplate>
                                                                                                    </ItemsControl>
                                                                                                </Grid>
                                                                                            </ScrollViewer>
                                                                                        </Grid>
                                                                                    </DataTemplate>
                                                                                </Setter.Value>
                                                                            </Setter>

                                                                            <Style.Triggers>
                                                                                <DataTrigger Binding="{Binding SelectedMaterialType}" Value="Параграфы">
                                                                                    <Setter Property="ContentTemplate">
                                                                                        <Setter.Value>
                                                                                            <DataTemplate>
                                                                                                <Grid>
                                                                                                    <Grid.RowDefinitions>
                                                                                                        <RowDefinition Height="Auto"/>
                                                                                                        <RowDefinition Height="*"/>
                                                                                                    </Grid.RowDefinitions>

                                                                                                    <Grid Grid.Row="0" Margin="5,0,5,5">
                                                                                                        <Grid.ColumnDefinitions>
                                                                                                            <ColumnDefinition Width="2*"/>
                                                                                                            <ColumnDefinition Width="2*"/>
                                                                                                            <ColumnDefinition Width="3*"/>
                                                                                                        </Grid.ColumnDefinitions>
                                                                                                        <TextBlock Grid.Column="0" Text="Раздел" FontSize="14" FontWeight="SemiBold" Foreground="#888"/>
                                                                                                        <TextBlock Grid.Column="1" Text="Тема" FontSize="14" FontWeight="SemiBold" Foreground="#888"/>
                                                                                                        <TextBlock Grid.Column="2" Text="Название параграфа" FontSize="14" FontWeight="SemiBold" Foreground="#888"/>
                                                                                                    </Grid>

                                                                                                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                                                                                                        <Grid>
                                                                                                            <TextBlock Text="Параграфов пока нет."
                                                                                                                       FontSize="18" Foreground="#666" HorizontalAlignment="Center" VerticalAlignment="Center"
                                                                                                                       Visibility="{Binding DataContext.ParagraphsPaging.Items.Count,RelativeSource={RelativeSource AncestorType=UserControl},Converter={StaticResource ZeroToVisibilityConverter}}"/>
                                                                                                            <ItemsControl ItemsSource="{Binding DataContext.ParagraphsPaging.Items, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                                                                                          Visibility="{Binding DataContext.ParagraphsPaging.Items.Count, RelativeSource={RelativeSource AncestorType=UserControl},Converter={StaticResource NotZeroToVisibilityConverter}}">
                                                                                                                <ItemsControl.ItemTemplate>
                                                                                                                    <DataTemplate DataType="{x:Type models:Paragraph}">
                                                                                                                        <Border BorderBrush="{StaticResource AccentBrush}" BorderThickness="0,0,0,1" Padding="5">
                                                                                                                            <Grid>
                                                                                                                                <Grid.ColumnDefinitions>
                                                                                                                                    <ColumnDefinition Width="2*"/>
                                                                                                                                    <ColumnDefinition Width="2*"/>
                                                                                                                                    <ColumnDefinition Width="3*"/>
                                                                                                                                </Grid.ColumnDefinitions>
                                                                                                                                <TextBlock Grid.Column="0" Text="{Binding Theme.Section.SectionTitle}" Foreground="{StaticResource PrimaryBrush}" TextTrimming="CharacterEllipsis" Style="{StaticResource TableTextStyle}"/>
                                                                                                                                <TextBlock Grid.Column="1" Text="{Binding Theme.ThemeTitle}" TextTrimming="CharacterEllipsis" Style="{StaticResource TableTextStyle}"/>
                                                                                                                                <TextBlock Grid.Column="2" Text="{Binding ParagraphTitle}" TextTrimming="CharacterEllipsis" Style="{StaticResource TableTextStyle}"/>
                                                                                                                            </Grid>
                                                                                                                        </Border>
                                                                                                                    </DataTemplate>
                                                                                                                </ItemsControl.ItemTemplate>
                                                                                                            </ItemsControl>
                                                                                                        </Grid>
                                                                                                    </ScrollViewer>
                                                                                                </Grid>
                                                                                            </DataTemplate>
                                                                                        </Setter.Value>
                                                                                    </Setter>
                                                                                </DataTrigger>
                                                                            </Style.Triggers>
                                                                        </Style>
                                                                    </ContentControl.Style>
                                                                </ContentControl>

                                                                <!-- Пагинация -->
                                                                <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,10,0,0">

                                                                    <!-- Назад -->
                                                                    <Button Content="◀ Назад"
                                                                            Command="{Binding PrevPageCommand}"
                                                                            Width="80" Height="50"
                                                                            Margin="5">
                                                                        <Button.Style>
                                                                            <Style TargetType="Button" BasedOn="{StaticResource SecondaryButtonStyle}">
                                                                                <Setter Property="IsEnabled" Value="{Binding TestsPaging.CanGoPrev}"/>
                                                                                <Style.Triggers>
                                                                                    <DataTrigger Binding="{Binding SelectedMaterialType}" Value="Параграфы">
                                                                                        <Setter Property="IsEnabled" Value="{Binding ParagraphsPaging.CanGoPrev}"/>
                                                                                    </DataTrigger>
                                                                                </Style.Triggers>
                                                                            </Style>
                                                                        </Button.Style>
                                                                    </Button>

                                                                    <!-- Текущая страница / Всего страниц -->
                                                                    <TextBlock VerticalAlignment="Center" Margin="5">
                                                                        <TextBlock.Style>
                                                                            <Style TargetType="TextBlock">
                                                                                <Setter Property="Text" Value="{Binding TestsPaging.CurrentPage}"/>
                                                                                <Style.Triggers>
                                                                                    <DataTrigger Binding="{Binding SelectedMaterialType}" Value="Параграфы">
                                                                                        <Setter Property="Text" Value="{Binding ParagraphsPaging.CurrentPage}"/>
                                                                                    </DataTrigger>
                                                                                </Style.Triggers>
                                                                            </Style>
                                                                        </TextBlock.Style>
                                                                    </TextBlock>

                                                                    <TextBlock Text="/" VerticalAlignment="Center"/>

                                                                    <TextBlock VerticalAlignment="Center" Margin="5">
                                                                        <TextBlock.Style>
                                                                            <Style TargetType="TextBlock">
                                                                                <Setter Property="Text" Value="{Binding TestsPaging.TotalPages}"/>
                                                                                <Style.Triggers>
                                                                                    <DataTrigger Binding="{Binding SelectedMaterialType}" Value="Параграфы">
                                                                                        <Setter Property="Text" Value="{Binding ParagraphsPaging.TotalPages}"/>
                                                                                    </DataTrigger>
                                                                                </Style.Triggers>
                                                                            </Style>
                                                                        </TextBlock.Style>
                                                                    </TextBlock>

                                                                    <!-- Вперед -->
                                                                    <Button Content="Вперед ▶"
                                                                            Command="{Binding NextPageCommand}"
                                                                            Width="80" Height="50"
                                                                            Margin="5">
                                                                        <Button.Style>
                                                                            <Style TargetType="Button" BasedOn="{StaticResource SecondaryButtonStyle}">
                                                                                <Setter Property="IsEnabled" Value="{Binding TestsPaging.CanGoNext}"/>
                                                                                <Style.Triggers>
                                                                                    <DataTrigger Binding="{Binding SelectedMaterialType}" Value="Параграфы">
                                                                                        <Setter Property="IsEnabled" Value="{Binding ParagraphsPaging.CanGoNext}"/>
                                                                                    </DataTrigger>
                                                                                </Style.Triggers>
                                                                            </Style>
                                                                        </Button.Style>
                                                                    </Button>
                                                                </StackPanel>
                                                            </Grid>
                                                        </Grid>
                                                    </ContentControl>

                                                    <ContentControl Visibility="{Binding IsShowingTestCreation, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                        <Grid Background="#FAFAFA">
                                                            <Grid.RowDefinitions>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="*"/>
                                                            </Grid.RowDefinitions>

                                                            <!-- Верхняя панель -->
                                                            <Grid Margin="0,15,0,25">
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="Auto"/>
                                                                    <ColumnDefinition Width="*"/>
                                                                    <ColumnDefinition Width="Auto"/>
                                                                </Grid.ColumnDefinitions>

                                                                <!-- Кнопка слева -->
                                                                <Button Grid.Column="0"
                                                                        Content="Вернуться к списку"
                                                                        Command="{Binding CancelTestCreationCommand}"
                                                                        Style="{StaticResource SecondaryButtonStyle}"
                                                                        VerticalAlignment="Center"
                                                                        Height="40"
                                                                        Width="150"
                                                                        Margin="0,0,15,0"/>

                                                                <!-- Заголовок -->
                                                                <TextBlock Grid.Column="1"
                                                                           Text="Создание нового теста"
                                                                           FontSize="32"
                                                                           FontWeight="Bold"
                                                                           Foreground="{StaticResource PrimaryBrush}"
                                                                           HorizontalAlignment="Center"
                                                                           VerticalAlignment="Center"/>

                                                                <!-- Пустышка справа -->
                                                                <Border Grid.Column="2"
                                                                        Width="150"
                                                                        Background="Transparent"/>
                                                            </Grid>

                                                            <!-- Основной контент -->
                                                            <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto">
                                                                <Border Background="White"
                                                                        CornerRadius="12"
                                                                        Padding="20"
                                                                        Margin="0,0,0,20">
                                                                    <StackPanel Width="650" HorizontalAlignment="Center" >

                                                                        <!-- Ошибка -->
                                                                        <Border Background="#FFEEEE" 
                                                                                BorderBrush="#FF7777" 
                                                                                BorderThickness="1" 
                                                                                CornerRadius="4" 
                                                                                Padding="12" 
                                                                                Margin="0,0,0,18" 
                                                                                HorizontalAlignment="Stretch"
                                                                                Visibility="{Binding ErrorVisibility}">
                                                                            <TextBlock Text="{Binding ErrorMessage}" 
                                                                                        Foreground="#D8000C" 
                                                                                        FontWeight="SemiBold" 
                                                                                        TextWrapping="Wrap"
                                                                                        HorizontalAlignment="Center"
                                                                                        VerticalAlignment="Center"/>
                                                                        </Border>

                                                                        <!-- 1. Раздел и тема -->
                                                                        <TextBlock Text="1. Выберите раздел и тему"
                                                                                   FontSize="22" FontWeight="SemiBold"
                                                                                   Foreground="{StaticResource PurpleBrush}"
                                                                                   Margin="0,0,0,12"/>

                                                                        <StackPanel Margin="0,0,0,12">
                                                                            <TextBlock Text="Раздел" FontWeight="Bold" Margin="0,0,0,4"/>
                                                                            <ComboBox ItemsSource="{Binding ImportSections}"
                                                                                        SelectedItem="{Binding SelectedImportSection}"
                                                                                        DisplayMemberPath="SectionTitle"
                                                                                        Style="{StaticResource PrimaryComboBoxStyle}"
                                                                                        ItemContainerStyle="{StaticResource PrimaryComboBoxItemStyle}"
                                                                                        Height="40"/>
                                                                        </StackPanel>

                                                                        <StackPanel Margin="0,0,0,16">
                                                                            <TextBlock Text="Тема" FontWeight="Bold" Margin="0,0,0,4"/>
                                                                            <ComboBox ItemsSource="{Binding ImportThemes}"
                                                                                      SelectedItem="{Binding SelectedImportTheme}"
                                                                                      DisplayMemberPath="ThemeTitle"
                                                                                      Style="{StaticResource PrimaryComboBoxStyle}"
                                                                                      ItemContainerStyle="{StaticResource PrimaryComboBoxItemStyle}"
                                                                                      Height="40"/>
                                                                        </StackPanel>

                                                                        <Separator Margin="0,10,0,16"/>

                                                                        <!-- 2. Название и попытки -->
                                                                        <TextBlock Text="2. Укажите параметры теста"
                                                                                   FontSize="22" FontWeight="SemiBold"
                                                                                   Foreground="{StaticResource PurpleBrush}"
                                                                                   Margin="0,0,0,12"/>

                                                                        <StackPanel Margin="0,0,0,12">
                                                                            <TextBlock Text="Название теста" FontWeight="Bold" Margin="0,0,0,4"/>
                                                                            <TextBox Text="{Binding NewTestName}"
                                                                                     TextWrapping="Wrap"
                                                                                     Style="{StaticResource PrimaryTextBoxStyle}"
                                                                                     Height="40" Padding="8" MaxLength="100"/>
                                                                        </StackPanel>

                                                                        <StackPanel Margin="0,0,0,16">
                                                                            <TextBlock Text="Количество попыток" FontWeight="Bold" Margin="0,0,0,4"/>
                                                                            <TextBox Text="{Binding NewTestMaxAttempts,UpdateSourceTrigger=PropertyChanged,Converter={StaticResource NullableIntConverter}}"
                                                                                     Style="{StaticResource PrimaryTextBoxStyle}"
                                                                                     Height="40"
                                                                                     Padding="8"
                                                                                     FontSize="16"
                                                                                     MaxLength="2"/>
                                                                        </StackPanel>

                                                                        <Separator Margin="0,10,0,16"/>

                                                                        <!-- 3. Импорт Excel -->
                                                                        <TextBlock Text="3. Импорт вопросов"
                                                                                   FontSize="22" FontWeight="SemiBold"
                                                                                   Foreground="{StaticResource PurpleBrush}"
                                                                                   Margin="0,0,0,10"/>

                                                                        <TextBlock Text="Загрузите Excel-файл с вопросами. Требуемые столбцы:"
                                                                                   FontSize="14" Foreground="#666" TextWrapping="Wrap" Margin="0,0,0,8"/>

                                                                        <Border Background="#F3F3F3"
                                                                                Padding="10"
                                                                                CornerRadius="6"
                                                                                Margin="0,0,0,12">
                                                                            <StackPanel>
                                                                                <TextBlock Text="• QuestionText — текст вопроса" Margin="0,2"/>
                                                                                <TextBlock Text="• AnswerText — ответ" Margin="0,2"/>
                                                                                <TextBlock Text="• IsCorrect (TRUE/FALSE)" Margin="0,2"/>
                                                                                <TextBlock Text="• Points — количество баллов" Margin="0,2"/>
                                                                            </StackPanel>
                                                                        </Border>

                                                                        <Button Content="Загрузить Excel и создать тест"
                                                                                Command="{Binding ImportTestCommand}"
                                                                                Style="{StaticResource AccentButtonStyle}"
                                                                                Height="50"
                                                                                Padding="20,0"
                                                                                HorizontalAlignment="Stretch"
                                                                                Width="Auto"
                                                                                Margin="0,10,0,0"/>
                                                                    </StackPanel>
                                                                </Border>
                                                            </ScrollViewer>
                                                        </Grid>
                                                    </ContentControl>

                                                </Grid>
                                            </DataTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </DataTrigger>

                            </Style.Triggers>
                        </Style>
                    </ContentControl.Style>
                </ContentControl>
            </Border>
        </Grid>
    </DockPanel>
</UserControl>