<UserControl x:Class="EducationProgram.Views.EducationView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:EducationProgram.Views"
             xmlns:converters="clr-namespace:EducationProgram.Converters"
             xmlns:models="clr-namespace:EducationProgram.Models"
             xmlns:viewmodels="clr-namespace:EducationProgram.ViewModels"
             xmlns:helpers="clr-namespace:EducationProgram.Helpers"
             helpers:KeyboardNavigationHelper.LeftCommand="{Binding PreviousQuestionCommand}"
             helpers:KeyboardNavigationHelper.RightCommand="{Binding NextQuestionCommand}"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="900" Cursor="">
    <UserControl.Resources>
        <converters:AddOneConverter x:Key="AddOneConverter"/>
        <converters:InverseBooleanToVisibilityConverter x:Key="InverseBoolToVisConverter"/>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:BoolToBackgroundConverter x:Key="BoolToBackgroundConverter"/>
        <converters:EqualityMultiConverter x:Key="EqualityMultiConverter"/>
        <converters:UserToIconConverter x:Key="UserToIcon"/>

        <DataTemplate DataType="{x:Type models:Question}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="50"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="50"/>
                </Grid.ColumnDefinitions>

                <!-- Кнопка Назад -->
                <Button Grid.Column="0"
                        Content="◀"
                        Cursor="Hand"
                        Command="{Binding DataContext.PreviousQuestionCommand, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type UserControl}}}"
                        Style="{StaticResource SecondaryButtonStyle}"
                        VerticalAlignment="Stretch"
                        Margin="0"
                        Focusable="True"/>

                <!-- Вопрос и ответы -->
                <Border Grid.Column="1"
                        Background="White"
                        BorderBrush="#E0E0E0"
                        BorderThickness="1"
                        CornerRadius="12"
                        Height="400"
                        Padding="25"
                        Margin="10,0,10,0">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <!-- Текст вопроса -->
                        <TextBlock Grid.Row="0"
                           Text="{Binding QuestionText, FallbackValue='Текст вопроса'}"
                           TextWrapping="Wrap"
                           FontWeight="SemiBold"
                           Foreground="{StaticResource SecondaryBrush}"
                           FontSize="20"
                           Margin="0,0,0,25"/>

                        <!-- Ответы -->
                        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="0,0,5,0">
                            <ItemsControl ItemsSource="{Binding Answers}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <RadioButton Content="{Binding AnswerText}"
                                             GroupName="{Binding QuestionId}"
                                             Style="{StaticResource AnswerRadioButtonStyle}">
                                            <RadioButton.InputBindings>
                                                <MouseBinding MouseAction="LeftClick"
                                                      Command="{Binding DataContext.SelectAnswerCommand, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type UserControl}}}"
                                                      CommandParameter="{Binding AnswerId}"/>
                                            </RadioButton.InputBindings>

                                            <RadioButton.IsChecked>
                                                <MultiBinding Converter="{StaticResource EqualityMultiConverter}" Mode="OneWay">
                                                    <Binding Path="DataContext.CurrentSelectedAnswerId" RelativeSource="{RelativeSource FindAncestor, AncestorType={x:Type UserControl}}" />
                                                    <Binding Path="AnswerId" />
                                                </MultiBinding>
                                            </RadioButton.IsChecked>

                                        </RadioButton>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </Grid>
                </Border>

                <!-- Кнопка Вперед -->
                <Button Grid.Column="2"
                        Content="▶"
                        Cursor="Hand"
                        Command="{Binding DataContext.NextQuestionCommand, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type UserControl}}}"
                        Style="{StaticResource SecondaryButtonStyle}"
                        VerticalAlignment="Stretch"
                        Margin="0"
                        Focusable="True"/>

                <!-- Горячие клавиши -->
                <Grid.InputBindings>
                    <KeyBinding Key="Left"
                        Command="{Binding DataContext.PreviousQuestionCommand, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type UserControl}}}"/>
                    <KeyBinding Key="Right"
                        Command="{Binding DataContext.NextQuestionCommand, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type UserControl}}}"/>
                </Grid.InputBindings>
            </Grid>
        </DataTemplate>
    </UserControl.Resources>

    <DockPanel LastChildFill="True" Background="{StaticResource BackgroundBrush}">
        <Border Background="{StaticResource PrimaryBrush}" Height="60" DockPanel.Dock="Top">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- Левая часть: меню и кнопка логина -->
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="15,0,0,0" Grid.Column="0">
                    <Image Source="pack://application:,,,/Resources/images/menu.png"
                   Width="30" Height="30" VerticalAlignment="Center"
                   HorizontalAlignment="Left" Margin="0,0,10,0" Cursor="Hand" ToolTip="Свернуть/развернуть панель"
                   Visibility="{Binding IsInTestMode, Converter={StaticResource InverseBoolToVisConverter}}">
                        <Image.InputBindings>
                            <MouseBinding MouseAction="LeftClick" Command="{Binding ToggleSidebarCommand}" />
                        </Image.InputBindings>
                        <Image.Style>
                            <Style TargetType="Image">
                                <Setter Property="Opacity" Value="0.5"/>
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Opacity" Value="1.0"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Image.Style>
                    </Image>

                    <Button Content="{Binding CurrentUser.Login, FallbackValue='Гость', TargetNullValue='Гость'}"
                    Command="{Binding NavigateToProfileCommand}"
                    Style="{StaticResource UserLoginButtonStyle}"
                    VerticalAlignment="Center" ToolTip="Перейти в профиль" />
                </StackPanel>

                <!-- Правая часть: иконка выхода -->
                <Image x:Name="LoginLogoutImage"
               Width="35" Height="35" VerticalAlignment="Center"
               HorizontalAlignment="Right" Margin="0,0,20,0" Cursor="Hand"
               Source="{Binding CurrentUser, Converter={StaticResource UserToIcon}}"
               Visibility="{Binding IsInTestMode, Converter={StaticResource InverseBoolToVisConverter}}"
               Grid.Column="1" ToolTip="Войти/Выйти">
                    <Image.InputBindings>
                        <MouseBinding MouseAction="LeftClick" Command="{Binding LogoutCommand}" />
                    </Image.InputBindings>
                    <Image.Style>
                        <Style TargetType="Image">
                            <Setter Property="Opacity" Value="0.5"/>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Opacity" Value="1.0"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Image.Style>
                </Image>
            </Grid>
        </Border>

        <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="{Binding SidebarWidth}" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

            <Border Grid.Column="0"
                    Background="{StaticResource WhiteForegroundBrush}"
                    Visibility="{Binding IsSidebarVisible, Converter={StaticResource BooleanToVisibilityConverter}}" Cursor=""
                    BorderBrush="{StaticResource PrimaryBrush}"
                    BorderThickness="0 0 1 0"
                    >

                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="15">

                        <!-- Переключение разделов -->
                        <Grid Margin="0,15,0,10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <Button Grid.Column="0"
                                    HorizontalAlignment="Left"
                                    Style="{StaticResource RoundedIconButtonStyle}"
                                    Command="{Binding PrevSectionCommand}" Height="45" Width="45">
                                <Image Source="pack://application:,,,/Resources/images/back.png"
                     Width="30" Height="30"/>
                            </Button>

                            <Button Grid.Column="1"
                                    HorizontalAlignment="Right"
                                    Style="{StaticResource RoundedIconButtonStyle}"
                                    Command="{Binding NextSectionCommand}" Height="45" Width="45" Cursor="Hand">
                                <Image Source="pack://application:,,,/Resources/images/forward.png"
                       Width="30" Height="30"/>
                            </Button>
                        </Grid>

                        <!-- Заголовок раздела -->
                        <Border Background="#EDE7F6" CornerRadius="6" Padding="10" Margin="0,0,0,10"
                BorderBrush="{StaticResource CardAccentBrush}" BorderThickness="1">
                            <TextBlock Text="{Binding CurrentSection.SectionTitle, StringFormat=Раздел: {0}}"
                       FontSize="20" FontWeight="Bold"
                       Foreground="{StaticResource CardAccentBrush}"/>
                        </Border>

                        <!-- Темы -->
                        <ItemsControl ItemsSource="{Binding CurrentSection.Themes}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="White" BorderBrush="{StaticResource CardAccentBrush}" BorderThickness="1"
                                            CornerRadius="6" Padding="12" Margin="0,0,0,12">
                                        <StackPanel>
                                            <!-- Заголовок темы -->
                                            <TextBlock Text="{Binding ThemeTitle}"
                                                       FontSize="18" FontWeight="SemiBold"
                                                       Margin="0,0,0,12"
                                                       Foreground="{StaticResource CardAccentBrush}"  TextWrapping="Wrap"/>
                                            <!-- Разделитель: визуально отделяет заголовок от содержимого -->
                                            <Border Height="1" Background="{StaticResource CardAccentBrush}" Margin="0,0,0,12" />
                                            <!-- Список параграфов темы -->
                                            <ItemsControl ItemsSource="{Binding Paragraphs}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <!-- Кнопка для выбора параграфа -->
                                                        <Button Command="{Binding DataContext.SelectParagraphCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                                CommandParameter="{Binding}"
                                                                Style="{StaticResource TransparentButtonStyle}"
                                                                Margin="0,0,0,8" Padding="8,6"
                                                                HorizontalContentAlignment="Stretch">
                                                            <Grid>
                                                                <Grid.ColumnDefinitions>
                                                                    <!-- Колонка для иконки -->
                                                                    <ColumnDefinition Width="40"/>
                                                                    <!-- Колонка для текста -->
                                                                    <ColumnDefinition Width="*"/>
                                                                </Grid.ColumnDefinitions>
                                                                <!-- Иконка параграфа -->
                                                                <Image Grid.Column="0"
                                                                       Source="pack://application:,,,/Resources/Images/paragraph.png"
                                                                       Width="40" Height="40"
                                                                       VerticalAlignment="Center" />
                                                                <!-- Название параграфа -->
                                                                <TextBlock Grid.Column="1"
                                                                           Text="{Binding ParagraphTitle}"
                                                                           FontSize="15"
                                                                           VerticalAlignment="Center"
                                                                           TextTrimming="CharacterEllipsis"/>
                                                            </Grid>
                                                        </Button>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                            <!-- Список тестов темы -->
                                            <ItemsControl ItemsSource="{Binding Tests}" Margin="0,4,0,0">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <!-- Кнопка для запуска теста -->
                                                        <Button Command="{Binding DataContext.StartTestCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                                CommandParameter="{Binding}"
                                                                Style="{StaticResource TransparentButtonStyle}"
                                                                Margin="0,0,0,8" Padding="8,6"
                                                                HorizontalContentAlignment="Stretch">
                                                            <Grid>
                                                                <Grid.ColumnDefinitions>
                                                                    <!-- Колонка для иконки -->
                                                                    <ColumnDefinition Width="40"/>
                                                                    <!-- Колонка для текста -->
                                                                    <ColumnDefinition Width="*"/>
                                                                </Grid.ColumnDefinitions>

                                                                <!-- Иконка теста -->
                                                                <Image Grid.Column="0"
                                                                       Source="pack://application:,,,/Resources/Images/tests.png"
                                                                       Width="40" Height="40"
                                                                       VerticalAlignment="Center" />
                                                                <!-- Название теста -->
                                                                <TextBlock Grid.Column="1"
                                                                           Text="{Binding TestName}"
                                                                           FontSize="15"
                                                                           VerticalAlignment="Center"
                                                                           TextTrimming="CharacterEllipsis"/>
                                                            </Grid>
                                                        </Button>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </ScrollViewer>
            </Border>

            <Grid Grid.Column="1" Margin="20">
                <ContentControl Content="{Binding}">
                    <ContentControl.Style>
                        <Style TargetType="ContentControl">

                            <!-- ==== БАЗОВЫЙ ШАБЛОН (параграф) ==== -->
                            <Setter Property="ContentTemplate">
                                <Setter.Value>
                                    <DataTemplate>
                                        <ScrollViewer Margin="20">
                                            <StackPanel>
                                                <TextBlock Text="{Binding SelectedParagraph.ParagraphTitle, FallbackValue='Нет заголовка'}"
                                               FontSize="24" FontWeight="Bold"
                                               Foreground="{StaticResource PrimaryBrush}"
                                               Margin="0,0,0,15"/>

                                                <Border Height="2"
                                            Background="{StaticResource AccentBrush}"
                                            Margin="0,0,0,20" />

                                                <TextBlock Text="{Binding SelectedParagraph.Path, FallbackValue='Нет содержимого'}"
                                               TextWrapping="Wrap"
                                               Foreground="{StaticResource SecondaryBrush}"
                                               FontSize="16"/>
                                            </StackPanel>
                                        </ScrollViewer>
                                    </DataTemplate>
                                </Setter.Value>
                            </Setter>

                            <Style.Triggers>

                                <!-- === PDF режим === -->
                                <DataTrigger Binding="{Binding IsPdfSelected}" Value="True">
                                    <Setter Property="ContentTemplate">
                                        <Setter.Value>
                                            <DataTemplate>
                                                <local:PdfView DataContext="{Binding PdfViewerViewModel}"/>
                                            </DataTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </DataTrigger>

                                <DataTrigger Binding="{Binding IsPreviewTestMode}" Value="True">
                                    <Setter Property="ContentTemplate">
                                        <Setter.Value>
                                            <DataTemplate>
                                                <Border Background="#FAFAFA"
        CornerRadius="12"
        Padding="25"
        Margin="25"
        BorderBrush="{StaticResource AccentBrush}"
        BorderThickness="1"
        VerticalAlignment="Top">
                                                    <StackPanel>
                                                        <TextBlock Text="{Binding CurrentTest.TestName, FallbackValue='Нет теста'}"
                   FontSize="28"
                   FontWeight="Bold"
                   Foreground="{StaticResource PrimaryBrush}"
                   Margin="0,0,0,15"
                   TextWrapping="Wrap"
                   HorizontalAlignment="Center"/>
                                                        <TextBlock Text="Готовы проверить свои знания? Нажмите кнопку ниже, чтобы начать."
                   FontSize="16"
                   Foreground="#666"
                   TextWrapping="Wrap"
                   Margin="0,0,0,25"
                   HorizontalAlignment="Center"/>
                                                        <Button Content="Пройти тест"
                FontSize="18"
                Command="{Binding BeginTestCommand}"
                Visibility="{Binding IsStudent, Converter={StaticResource BooleanToVisibilityConverter}}"
                Style="{StaticResource SecondaryButtonStyle}"
                HorizontalAlignment="Center"
                MinWidth="300"
                Height="50"
                Margin="0,0,0,10"/>
                                                        <TextBlock FontSize="14"
                   Foreground="{StaticResource CardAccentBrush}"
                   HorizontalAlignment="Center"
                   TextWrapping="Wrap">
            <Run Text="У вас осталось попыток: "/>
            <Run Text="{Binding RemainingAttempts}" FontWeight="Bold"/>
            <Run Text=" из "/>
            <Run Text="{Binding MaxAttempts}" FontWeight="Bold"/>
                                                        </TextBlock>
                                                    </StackPanel>
                                                </Border>

                                            </DataTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </DataTrigger>

                                <DataTrigger Binding="{Binding IsTestMode}" Value="True">
                                    <Setter Property="ContentTemplate">
                                        <Setter.Value>
                                            <DataTemplate>
                                                <StackPanel Margin="15">
                                                    <TextBlock Text="{Binding CurrentTest.TestName, FallbackValue='Тест'}"
                                                   FontSize="28"
                                                   FontWeight="Bold"
                                                   Foreground="{StaticResource PrimaryBrush}"
                                                   Margin="0,0,0,15"/>

                                                    <Border BorderBrush="#E0E0E0"
                                                            BorderThickness="0,0,0,1"
                                                            Margin="0,0,0,20"
                                                            Padding="0,0,0,10">
                                                        <TextBlock HorizontalAlignment="Left">
                                                            <Run Text="Вопрос " FontSize="14" Foreground="#888"/>
                                                            <Run Text="{Binding CurrentQuestionIndex, Converter={StaticResource AddOneConverter}}"
                                                                 FontWeight="Bold"
                                                                 FontSize="14"
                                                                 Foreground="#666"/>
                                                            <Run Text=" из " FontSize="14" Foreground="#888"/>
                                                            <Run Text="{Binding CurrentTest.Questions.Count, Mode=OneWay}"  FontWeight="Bold"
                                                                FontSize="14"
                                                                Foreground="#666"/>
                                                        </TextBlock>
                                                    </Border>

                                                    <ContentControl Content="{Binding CurrentQuestion}"/>

                                                    <Button Content="Завершить тест"
                                                            Command="{Binding FinishTestCommand}"
                                                            Visibility="{Binding CanGoNext, Converter={StaticResource InverseBoolToVisConverter}}"
                                                            Style="{StaticResource SecondaryButtonStyle}"
                                                            HorizontalAlignment="Stretch"
                                                            Height="50"
                                                            Margin="0,10,0,0"/>
                                                </StackPanel>
                                            </DataTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ContentControl.Style>
                </ContentControl>
            </Grid>
        </Grid>
    </DockPanel>
</UserControl>